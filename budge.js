levels = [{title: "Aclimatizer", lines: [
    "####################",
    "#++++++++++++++++++#",
    "#+                +#",
    "#+                +#",
    "#+    ##+##+##    +#",
    "#+    #      #    +#",
    "#+    +      +    +#",
    "#+ P  #     *#   @+#",
    "#+    +      +    +#",
    "#+    #      #    +#",
    "#+    ##+##+##    +#",
    "#+                +#",
    "#+                +#",
    "#++++++++++++++++++#",
    "####################",
]}, {title: "The First Problem", lines: [
    "####            ####",
    "# @##############* #",
    "#  #            #  #",
    "#  +     ##     +  #",
    "####            ####",
    "#  #            #  #",
    "#                  #",
    "#                  #",
    "#                  #",
    "##      ####      ##",
    "#        P         #",
    "#                  #",
    "#                  #",
    "#  ##############  #",
    "####            ####",
]}, {title: "The Room of Zorch", lines: [
    "####################",
    "#       #          #",
    "#       # ##       #",
    "#      ##  ##      #",
    "#     ##    ##     #",
    "#    ##      ##    #",
    "#   ##        ##   #",
    "#* ##          ++ P#",
    "#   ##         ##  #",
    "#    ##       ##   #",
    "#     ##     ##    #",
    "#      ##   ##     #",
    "#       ##@##      #",
    "#        + +       #",
    "####################",
]}, {title: "Ever Decreasing Circles", lines: [
    "####################",
    "##                 #",
    "#             #  P #",
    "#               #  #",
    "#   #              #",
    "#           #      #",
    "#     #            #",
    "#            #     #",
    "#    #             #",
    "#              #   #",
    "#      #           #",
    "#                # #",
    "# #              * #",
    "#@                 #",
    "####################",
]}, {title: "Release Me", lines: [
    "####################",
    "#                  #",
    "# ######    ###### #",
    "# #*   # P  #@   # #",
    "# #    +    +    # #",
    "# #    #    #    # #",
    "# ##  ##    ##oo## #",
    "#  #  #      #  #  #",
    "#  #  #      #  #  #",
    "#  ####      ####  #",
    "#                  #",
    "#                  #",
    "#                  #",
    "#     #      #     #",
    "####################",
]}, {title: "Six Pack", lines: [
    "####################",
    "#@    #  P   #    *#",
    "#     #      #     #",
    "#     #      #     #",
    "#     #      #     #",
    "#     #      #     #",
    "#     #      #     #",
    "##+++###oooo###+++##",
    "#     #      #     #",
    "#     +      +     #",
    "#     +      +     #",
    "#     +      +     #",
    "#     +      +     #",
    "#     #      #     #",
    "####################",
]}, {title: "Stairway to Devon", lines: [
    "####################",
    "#* # # # # # # # # #",
    "#                  #",
    "#oooooooooooooo#o###",
    "#            #     #",
    "#          #      P#",
    "#        #      ####",
    "#      #      ###   ",
    "#    #      ###     ",
    "#  #      ###       ",
    "##      ###         ",
    "#     ###           ",
    "#   ###             ",
    "#@###               ",
    "###                 ",
]}, {title: "The Room with No Name", lines: [
    "####################",
    "#                  #",
    "#    #####   ###   #",
    "#     +o+##### #   #",
    "#    ###      @#   #",
    "#     +oo+#### #   #",
    "#    ###       ##  #",
    "#*#   +oo+####    P#",
    "#    ###       ##  #",
    "#     +oo+#### #   #",
    "#    ###       #   #",
    "#     +o+##### #   #",
    "#    #####   ###   #",
    "#                  #",
    "####################",
]}, {title: "The Inner Sanctum", lines: [
    "####################",
    "#                 P#",
    "# oooooooooooooooo #",
    "# o              o #",
    "# o              o #",
    "# o  ++++++++++  o #",
    "# o  +        +  o #",
    "# o  +        +  o #",
    "# o  +*       +  o #",
    "# o  ++++++++++  o #",
    "# o              o #",
    "# o              o #",
    "# oooooooooooooooo #",
    "#@                 #",
    "####################",
]}, {title: "A Sneaky Trick", lines: [
    "####################",
    "#        #        @#",
    "# ######+# #########",
    "# #      # #+#     #",
    "# #      # + #     #",
    "# #      ### #     #",
    "# ####     # #     #",
    "# #+ +  P  # #     #",
    "# ## #     # #     #",
    "# ## #       ##    #",
    "# #+         +#    #",
    "# ##+#+#####+##    #",
    "#  #####   ###*    #",
    "#      o   +       #",
    "####################",
]}, {title: "Just Enough", lines: [
    "#######o####o#######",
    "#     ###  ###     #",
    "#  #  # #  # #  #  #",
    "####     oo     ####",
    "#  #  #      #  +  #",
    "#P +  #      #  #  #",
    "#  #  #      #  #  #",
    "####  #  ##  #  ####",
    "#  #  #      #  #  #",
    "#  +  #      #  #  #",
    "#@ #  #      #  +* #",
    "####     oo     ####",
    "#  #  # #  # #  #  #",
    "#     ###  ###     #",
    "#######o####o#######",
]}, {title: "Act Quickly!", lines: [
    "####################",
    "#                  #",
    "# o  o  o  o  o  o #",
    "#                  #",
    "#  o  o  o  o  o   #",
    "#                  #",
    "#   o  o  o  o  o  #",
    "# *@              P#",
    "# o  o  o  o  o  o #",
    "#                  #",
    "#  o  o  o  o  o   #",
    "#                  #",
    "#   o  o  o  o  o  #",
    "#                  #",
    "####################",
]}, {title: "Act Even More Quickly!!", lines: [
    "###              ###",
    "# ################*#",
    "#        o         #",
    "#         o        #",
    "#        o         #",
    "#         o        #",
    "#        o         #",
    "#        Po        #",
    "#        o         #",
    "#         o        #",
    "#        o         #",
    "#         o        #",
    "#        o         #",
    "#@################ #",
    "###              ###",
]}, {title: "Peg It", lines: [
    "####################",
    "#@                 #",
    "#   ## ## ## ## ## #",
    "# #  #  #  #  #  # #",
    "#                  #",
    "#                  #",
    "#          o       #",
    "#*         o      P#",
    "#          o       #",
    "#                  #",
    "#                  #",
    "# #     #     #    #",
    "#  #+    #+    #+  #",
    "#    #     #     # #",
    "####################",
]}, {title: "Clockwise - Anticlockwise", lines: [               
    "####            ####",
    "#  ##############  #",
    "#                  #",
    "## +++########+++ ##",
    " # +            + #",
    " # +            + #",
    " # #    +x+x    # #",
    " #P#  o x+x+ o *#@#",
    " # #    +x+x    # #",
    " # +            + #",
    " # +            + #",
    "## +++########+++ ##",
    "#                  #",
    "#  ##############  #",
    "####            ####",
]}, {title: "Too Pushy", lines: [
    " o o o o o o o o o o",
    "o o o o o o o o o o",
    " o o o o o o o o o o",
    "o o o o o o o o o o",
    " o o o o o o o o o o",
    "o o o o o o o o o o",
    " o o o o o o o o o o",
    "@ o o o o P o o o o*",
    " o o o o o o o o o o",
    "o o o o o o o o o o",
    " o o o o o o o o o o",
    "o o o o o o o o o o",
    " o o o o o o o o o o",
    "o o o o o o o o o o",
    " o o o o o o o o o o",
]}, {title: "Figure of Eight", lines: [
    "####################",
    "#                  #     ",
    "# o o o o o        #",
    "#+####+++++   P    #          ",
    "###++######        #",
    "#        +#        #",
    "#     ## +#        #",
    "# #    # ##        #",
    "#   #  # #+        #",
    "#    # # #+        #",
    "#  ##  # #+        #",
    "# #@   # #+        #",
    "#  #  ##         + # ",
    "#    ###+++      +*#",
    "####################",
]}, {title: "What The Eye Can't See", lines: [
    "######        ######",
    "#    #        #    #",
    "##-  ##########  -##",
    "# -  #        #  -*#",
    "#    #   oo   #  - #",
    "#    #        #  - #",
    "# -  #  #  #  #  - #",
    "# -  +  #P #  +  - #",
    "# -  #  #  #  #  - #",
    "# -  #        #    #",
    "# -  #   oo   #    #",
    "#@-  #        #  - #",
    "##-  ##########  -##",
    "#    #        #    #",
    "######        ######",
]}, {title: "Beyond Perception", lines: [
    "####################",
    "#P                 #",
    "# -+-------------- #",
    "# -              + #",
    "# - -o---------- - #",
    "# - -          o - #",
    "# - - - ------ - - #",
    "# - - -  *   - - - #",
    "# - - ------ - - - #",
    "# - o          - - #",
    "# - ----------o- - #",
    "# +              - #",
    "# --------------+- #",
    "#@                 #",
    "####################",
]}, {title: "Hidden Charms", lines: [
    "++################++",
    "+      o    o      +",
    "#      #++++#      #",
    "#       #-##       #",
    "# -  ####  ####  - +",
    "#     -f   -       #",
    "# -  ####  ####  - #",
    "#     -f-  -f-  P  +",
    "# -  ####  ####  - #",
    "#          -f-     #",
    "# -  ####@ ####  - +",
    "#       ##-#       #",
    "#      #++++#      #",
    "+      o    o      +",
    "++################++*",
]}];
var curLevel;
var title;
var tiles;
var imgs;
var fluffyDir;
var freezeRemaining;
var pause;
function loadLevel(num) {
    curLevel = num;
    title = levels[num].title;
    tiles = levels[num].lines.map(function(line) {
        return line.split('');
    });
    fluffyDir = 'r';
    freezeRemaining = 0;
    pause = false;
    update();
}
function getImgSrc(d, pos) {
    var name = {
        ' ': 'empty',
        '-': 'invisible',
        '+': 'gate',
        'o': 'disk',
        'x': 'killer',
        'f': 'freeze',
        'P': 'player',
        '*': 'spiky',
        '@': 'squashy',
        '!': 'dead',
        '&': 'heart',
    }[d];
    if (d == '#') {
        name = 'blocks/block';
        var suffix = '';
        'udlr'.split('').forEach(function(dir) {
            var neighbor = translate(pos, dir, true);
            if (neighbor.row >= 0
                && neighbor.row < 15
                && neighbor.col >= 0
                && neighbor.col < 20
                && tiles[neighbor.row][neighbor.col] == '#') {
                    suffix += dir;
            }
        });
        if (suffix) {
            name += '_' + suffix;
        }
    }
    return 'lib/bitmaps/' + name + '.png';
}
function update() {
    document.getElementById('name').innerText = title;
    if (!imgs) {
        imgs = [];
        for (var row = 0; row < 15; row++) {
            var rowImgs = [];
            var rowEl = document.createElement('row');
            for (var col = 0; col < 20; col++) {
                var imgEl = document.createElement('img');
                rowEl.appendChild(imgEl);
                rowImgs.push(imgEl);
            }
            document.getElementById('board').appendChild(rowEl);
            imgs.push(rowImgs);
        }
    }
    for (var row = 0; row < 15; row++) {
        for (var col = 0; col < 20; col++) {
            var imgSrc = getImgSrc(tiles[row][col], {row: row, col: col});
            imgs[row][col].src = imgSrc;
        }
    }
}
function getPos(symbol) {
    for (var row=0; row<tiles.length; row++) {
        for (var col=0; col<tiles[row].length; col++) {
            if (tiles[row][col] == symbol) {
                return {row: row, col: col};
            }
        }
    }
}
function translate(pos, offset, nowrap) {
    switch (offset) {
        case 'l':
            offset = {row: 0, col: -1};
            break;
        case 'r':
            offset = {row: 0, col: 1};
            break;
        case 'u':
            offset = {row: -1, col: 0};
            break;
        case 'd':
            offset = {row: 1, col: 0};
            break;
    }
    // This doesn't work for large negative numbers
    var target = {
        row: pos.row + offset.row,
        col: pos.col + offset.col
    };
    if (!nowrap) {
        target.row = (target.row + 15) % 15;
        target.col = (target.col + tiles[target.row].length) % tiles[target.row].length;
    }
    return target;
}
function handleKeyDown(e) {
    var cur = getPos('P');
    if (cur == null) {
        return;
    }
    var dir;
    switch (e.keyCode) {
        case 37: // Left
            dir = 'l';
            break;
        case 38: // Up
            dir = 'u';
            break;
        case 39: // Right
            dir = 'r';
            break;
        case 40: // Down
            dir = 'd';
            break;
        case 27: // Escape
            loadLevel(curLevel);
            return;
        case 81: // Q
            // TODO: Reset lives
            loadLevel(0);
            return;
        case 80: // P
            pause = !pause;
            return;
        default:
            return;
    }
    if (pause) {
        return;
    }
    var target = translate(cur, dir);
    if (target) {
        e.preventDefault();
        e.stopPropagation();
        switch (tiles[target.row][target.col]) {
            case ' ':
            case '+':
                tiles[cur.row][cur.col] = ' ';
                tiles[target.row][target.col] = 'P';
                break;
            case 'o':
                var disk_target = translate(target, dir);
                if (disk_target && tiles[disk_target.row][disk_target.col] == ' ') {
                    tiles[cur.row][cur.col] = ' ';
                    tiles[target.row][target.col] = 'P';
                    tiles[disk_target.row][disk_target.col] = 'o';
                }
                break;
            case '@':
            case '*':
                tiles[cur.row][cur.col] = ' ';
                tiles[target.row][target.col] = '!';
                // TODO: Lose a life, use better tile
                break;
        }
        update();
    }
}
function calculateFluffyTargetAndUpdateDir(fluffyCur) {
    var target = translate(fluffyCur, fluffyDir);
    if (target == null) {
        return null;
    }
    switch (tiles[target.row][target.col]) {
        case '*':
        case 'P':
        case ' ':
            return target;
        default:
            var nextDir = "uldr";
            fluffyDir = nextDir[(nextDir.indexOf(fluffyDir) + 1) % 4]
            return fluffyCur;
    }
}
function calculateSpikyTarget(spikyCur, playerCur) {
    if (playerCur == null) {
        return null;
    }
    var target = translate(spikyCur, {
        row: Math.sign(playerCur.row - spikyCur.row),
        col: Math.sign(playerCur.col - spikyCur.col),
    });
    switch (tiles[target.row][target.col]) {
        case '@':
        case 'P':
        case ' ':
            return target;
        default:
            return spikyCur;
    }
}
function posEq(a, b) {
    return a != null && b != null && a.row == b.row && a.col == b.col;
}
function moveMonsters() {
    var fluffyCur = getPos('@');
    var spikyCur = getPos('*');
    var playerCur = getPos('P');
    if (playerCur == null || pause) {
        return;
    }
    var fluffyTarget = fluffyCur == null ? null : calculateFluffyTargetAndUpdateDir(fluffyCur);
    var spikyTarget = spikyCur == null ? null : calculateSpikyTarget(spikyCur, playerCur);
    if (posEq(fluffyTarget, playerCur) || posEq(spikyTarget, playerCur)) {
        tiles[playerCur.row][playerCur.col] = '!';
        // TODO: Remove monster(s) from current tile
        // TODO: Lose a life
        return;
    }
    if (posEq(fluffyTarget, spikyTarget)) {
        tiles[fluffyTarget.row][fluffyTarget.col] = '&';
        if (!posEq(fluffyCur, fluffyTarget)) {
            tiles[fluffyCur.row][fluffyCur.col] = ' ';
        }
        if (!posEq(spikyCur, spikyTarget)) {
            tiles[spikyCur.row][spikyCur.col] = ' ';
        }
        return;
    }
    if (fluffyCur != null && !posEq(fluffyCur, fluffyTarget)) {
        tiles[fluffyCur.row][fluffyCur.col] = ' ';
        tiles[fluffyTarget.row][fluffyTarget.col] = '@';
    }
    if (spikyCur != null && !posEq(spikyCur, spikyTarget)) {
        if (!posEq(spikyCur, fluffyTarget)) {
            tiles[spikyCur.row][spikyCur.col] = ' ';
        }
        tiles[spikyTarget.row][spikyTarget.col] = '*';
    }
}
function checkLevelOver() {
    if (getPos('!') != null) {
        // TODO: lives--
        loadLevel(curLevel);
    } else if (getPos('&') != null) {
        // TODO: Check if no more levels
        loadLevel(curLevel + 1);
    }
}

// TODO: Add border around game board
// TODO: Make sure last level with hidden tile works right
// TODO: Add touch screen support
document.addEventListener("keydown", function(e) { if (!pause) handleKeyDown(e); });
loadLevel(0);
setInterval(function() { if (!pause) { if (!checkLevelOver()) {moveMonsters()}; update(); } }, 250);
